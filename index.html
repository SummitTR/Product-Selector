<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Summit – Product Review & Selection App (Sample Build)</title>
  <style>
    :root{
      --brand:#254a4f;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --bg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--brand)}
    .container{max-width:1120px;margin:0 auto;padding:16px}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.65rem;border:1px solid var(--border);background:#fff;padding:.6rem .9rem;font-size:.95rem;cursor:pointer}
    .btn:hover{background:#f9fafb}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.primary:hover{filter:brightness(.98)}
    .btn.sm{padding:.45rem .7rem;font-size:.85rem}
    .chip{display:inline-flex;align-items:center;gap:.25rem;border:1px solid var(--border);padding:.2rem .5rem;border-radius:999px;font-size:.8rem;background:#fff}
    .tag{font-size:.75rem;color:#374151}
    .hidden{display:none !important}
    .grid{display:grid;gap:16px}
    .grid.cards{grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:640px){.grid.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:960px){.grid.cards{grid-template-columns:repeat(3,minmax(0,1fr))}}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
    header .container{display:flex;align-items:center;justify-content:space-between;padding-block:10px}
    .brand{display:flex;align-items:center;gap:.75rem}
    .logo{width:36px;height:36px;border-radius:8px;background:var(--brand)}
    nav button{border:none;background:transparent;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
    nav button[aria-current="page"]{text-decoration:underline;font-weight:600}
    .card{display:flex;flex-direction:column;overflow:hidden;border:1px solid var(--border);border-radius:16px;background:#fff;transition:box-shadow .2s, transform .2s;position:relative}
    .card.selected{box-shadow:0 0 0 2px rgba(37,74,79,.35)}
    .card img{width:100%;aspect-ratio:4/3;object-fit:cover;background:#f3f4f6}
    .card-body{padding:12px}
    .muted{color:var(--muted)}
    .title{font-weight:700}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .controls{display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center}
    .field input,.field select,.field textarea{width:100%;padding:.55rem .7rem;border:1px solid var(--border);border-radius:.5rem}
    .field label{display:block;font-size:.9rem;font-weight:600;margin-bottom:.25rem}
    .toolbar{display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:12px}
    .panel{border:1px solid var(--border);border-radius:16px;padding:16px;background:#fff}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:#fff;border-radius:16px;max-width:960px;width:100%;max-height:90vh;overflow:auto;border:1px solid var(--border)}
    .modal header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;z-index:1}
    .modal .content{padding:16px}
    .imgbox{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .imgbox button{position:absolute;top:50%;transform:translateY(-50%);background:#fff;border:1px solid var(--border);border-radius:999px;padding:.4rem;cursor:pointer}
    .imgbox .prev{left:8px}.imgbox .next{right:8px}
    .disclosure{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .disclosure summary{list-style:none;padding:10px 12px;background:#f7faf9;cursor:pointer;font-weight:600}
    .disclosure summary::-webkit-details-marker{display:none}
    .disclosure .body{padding:12px}
    .list-compact{display:grid;gap:12px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:720px){.list-compact{grid-template-columns:repeat(2,minmax(0,1fr))}}
    iframe.embed{width:100%;height:320px;border:1px solid var(--border);border-radius:10px}
    footer{border-top:1px solid var(--border);padding:16px;text-align:center;color:#6b7280;margin-top:40px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .badge{position:absolute;top:10px;right:10px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:.25rem .5rem;font-size:.8rem;display:flex;align-items:center;gap:.25rem}
    /* print */
    @media print{
      header, .no-print, nav, .toolbar button, .admin, .sendonly, .controls .btn, .disclosure summary, .print-hide{display:none !important}
      .panel{border:none;padding:0}
      .container{max-width:100%;padding:0 8px}
      footer{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Summit Product Learning Center</div>
          <div class="tag">Browse • Select • Save/Print • Send</div>
        </div>
      </div>
      <div class="row">
        <div class="chip" title="Selected count"><span id="selCount">0</span></div>
        <div class="chip" title="Total price">$<span id="selTotal">0</span></div>
        <nav class="no-print">
          <button data-step="1" aria-current="page">Welcome</button>
          <button data-step="2">View & Select</button>
          <button data-step="3">Save/Print</button>
          <button data-step="4">Send</button>
          <button data-step="5">Exit</button>
        </nav>
        <button class="btn sm admin" id="btnAdmin" title="Toggle Admin (CSV Import)">Admin</button>
      </div>
    </div>
  </header>

  <main id="step1">
    <section class="container" style="padding-block:32px">
      <div class="panel">
        <div class="grid" style="grid-template-columns:1fr;gap:20px">
          <div>
            <h1 style="margin:0 0 8px">Find the right Summit equipment for your tasks</h1>
            <p class="muted">Scan summaries, open details, select what you like, then save/print your list—or send it to us for follow-up.</p>
            <div class="row" style="margin-top:12px">
              <button class="btn primary" onclick="gotoStep(2)">Get Started</button>
              <button class="btn" onclick="closeApp()">Close App</button>
            </div>
          </div>
          <div>
            <div class="imgbox">
              <img alt="Summit equipment on property" src="https://images.unsplash.com/photo-1505859833435-08a3d2c1b313?q=80&w=1200&auto=format&fit=crop" />
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <main id="step2" class="hidden">
    <section class="container">
      <div class="toolbar">
        <div class="controls">
          <div class="field">
            <label class="sr-only" for="q">Search</label>
            <input id="q" placeholder="Search products, SKU, model…" oninput="renderList()" />
          </div>
          <div class="field">
            <label class="sr-only" for="filterApp">Application</label>
            <select id="filterApp" onchange="renderList()">
              <option>All</option>
            </select>
          </div>
          <div class="field">
            <label class="sr-only" for="sortBy">Sort</label>
            <select id="sortBy" onchange="renderList()">
              <option value="SortOrder">Featured</option>
              <option value="Name">Name A→Z</option>
              <option value="PriceLowHigh">Price: Low→High</option>
              <option value="PriceHighLow">Price: High→Low</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button class="btn" onclick="selectAllFiltered()">Select All (Filtered)</button>
          <button class="btn" onclick="removeAllFiltered()">Remove All (Filtered)</button>
          <button class="btn primary" onclick="gotoStep(3)">Save / Print</button>
        </div>
      </div>

      <div id="adminBar" class="panel admin hidden">
        <div class="row" style="justify-content:space-between">
          <div class="muted"><strong>Admin:</strong> Import CSV (Active rows only). Version displays at bottom.</div>
          <label class="btn">
            <input type="file" accept=".csv" class="sr-only" id="csvInput" />
            Import CSV
          </label>
          <button class="btn" id="btnExportCSV">Export CSV</button>
        </div>
      </div>

      <div id="stats" class="muted" style="margin:.25rem 0 .75rem"></div>
      <div id="cards" class="grid cards"></div>
      <div class="muted" style="margin-top:8px;font-size:.85rem">
        CSV Version: <span id="csvVersion">Embedded sample v1</span> • Loaded <span id="csvLoaded">from build</span>
      </div>
    </section>
  </main>

  <main id="step3" class="hidden">
    <section class="container">
      <div class="toolbar">
        <h2 style="margin:0">Selected Products</h2>
        <div><button class="btn" onclick="window.print()">Print / Save PDF</button></div>
      </div>
      <div id="selectedList" class="grid"></div>
    </section>
  </main>

  <main id="step4" class="hidden">
    <section class="container">
      <div id="sendPhasePitch" class="panel">
        <h3 style="margin-top:0">Send your selections to a Product Specialist</h3>
        <ul>
          <li>Fast answers to fit &amp; compatibility questions</li>
          <li>Help with financing &amp; promotions</li>
          <li>Recommendations for seasonal accessories</li>
        </ul>
        <div class="row">
          <button class="btn primary" onclick="openLeadForm()">Proceed</button>
          <button class="btn" onclick="gotoStep(5)">Not now</button>
        </div>
      </div>

      <div id="leadForm" class="hidden">
        <form class="panel" onsubmit="submitLead(event)">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">Your Info</h3>
            <div class="row">
              <label>Send via
                <select id="sendMode">
                  <option value="email">Email</option>
                  <option value="web2lead">Salesforce Web-to-Lead</option>
                </select>
              </label>
            </div>
          </div>
          <div class="grid" style="grid-template-columns:1fr;gap:12px">
            <div class="field"><label for="name">Full Name</label><input id="name" required /></div>
            <div class="field"><label for="email">Email</label><input id="email" type="email" required /></div>
            <div class="field"><label for="phone">Phone</label><input id="phone" /></div>
            <div class="field"><label for="notes">Notes</label><textarea id="notes" rows="4" placeholder="Tell us about your property or tasks"></textarea></div>
          </div>
          <div class="row" style="align-items:center;margin-top:.25rem">
            <input id="hpCompany" class="sr-only" autocomplete="organization" />
            <span id="captchaQ" class="tag"></span>
            <input id="captchaA" inputmode="numeric" style="width:70px" />
          </div>
          <div id="leadErr" class="muted" style="color:#b91c1c"></div>
          <div class="row">
            <button class="btn primary" id="btnSubmitLead" type="submit">Submit</button>
            <span class="muted">We don’t store PII client-side beyond this session.</span>
          </div>
        </form>

        <div style="margin-top:12px">
          <h4 class="tag">You're sending</h4>
          <div id="sendingList" class="list-compact"></div>
        </div>
      </div>

      <div id="leadThanks" class="panel hidden" style="text-align:center">
        <h3>Thanks! Your request has been submitted.</h3>
        <p class="muted">We’ll be in touch soon.</p>
        <button class="btn" onclick="gotoStep(5)">Close</button>
      </div>
    </section>
  </main>

  <main id="step5" class="hidden">
    <section class="container" style="padding-block:32px;text-align:center">
      <h2>Thank you!</h2>
      <p class="muted">You can close this window or return to the beginning.</p>
      <div class="row" style="justify-content:center">
        <button class="btn" onclick="gotoStep(2)">Back to Products</button>
        <button class="btn primary" onclick="gotoStep(1)">Go to Welcome</button>
      </div>
    </section>
  </main>

  <!-- Details Modal -->
  <div id="modalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row">
        <strong id="mdTitle">Product Details</strong>
        <button class="btn sm" onclick="closeModal()">Close</button>
      </header>
      <div class="content">
        <div class="grid" style="grid-template-columns:1fr;gap:16px">
          <div>
            <div class="imgbox">
              <img id="mdImg" alt="Product image" style="width:100%;aspect-ratio:4/3;object-fit:cover" />
              <button class="prev" onclick="prevImg()" aria-label="Previous image">◀</button>
              <button class="next" onclick="nextImg()" aria-label="Next image">▶</button>
            </div>
            <p id="mdLong" style="margin:10px 0 0"></p>
          </div>
          <div>
            <div><strong>Key Features</strong><ul id="mdFeat" style="margin:6px 0 0 18px"></ul></div>
            <details class="disclosure" style="margin-top:10px">
              <summary>Watch Video</summary>
              <div class="body"><iframe id="mdVideo" class="embed" allowfullscreen></iframe></div>
            </details>
            <details class="disclosure" style="margin-top:10px">
              <summary>View Specifications (PDF)</summary>
              <div class="body"><iframe id="mdBrochure" class="embed" title="Specifications PDF"></iframe></div>
            </details>
            <details class="disclosure" style="margin-top:10px">
              <summary>View Manual (PDF)</summary>
              <div class="body"><iframe id="mdManual" class="embed" title="Manual PDF"></iframe></div>
            </details>
            <details class="disclosure" style="margin-top:10px">
              <summary>Seasonal Uses (PDF)</summary>
              <div class="body"><iframe id="mdSeasonal" class="embed" title="Seasonal Uses PDF"></iframe></div>
            </details>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="no-print">
    © <span id="year"></span> Summit. Built mobile-first. WCAG-minded.
  </footer>

<script>
/* ----------------- CONFIG: endpoints & mapping (EDIT THESE) ----------------- */
const CONFIG = {
  retailerURL: "https://summittractors.com/find-a-retailer",
  email: {
    // Point this to your server-side email handler (e.g., /api/send-email).
    // It should accept POST JSON: { contact, selectedSummary, selectedProductIDs, timestamp }
    endpoint: "/api/send-email",
    // Optional: include headers or API keys if your handler expects them (never put secrets in a public build).
    headers: {}
  },
  salesforce: {
    // Standard Web-to-Lead endpoint. Replace with your region-specific endpoint if needed.
    endpoint: "https://webto.salesforce.com/servlet/servlet.WebToLead?encoding=UTF-8",
    // Required Org ID
    orgId: "YOUR_ORG_ID_HERE",
    // Map HTML field names to SF field API names.
    // Left side: our app data; Right side: your SF field API names
    fieldMap: {
      last_name: "last_name",     // we'll use Full Name -> last_name for demo; adjust to your schema
      email: "email",
      phone: "phone",
      description: "description",  // notes + product summary
      // Add any custom fields here, e.g. "00N5g00000XXXX": "Custom_Field__c"
    }
  }
};
/* ----------------- End CONFIG ----------------- */

/* ---------- Sample Data (replace via Admin → CSV Import) ---------- */
const SAMPLE_PRODUCTS = [
  {
    "ProductID":"PI-TX25HLX85",
    "Category":"Tractors",
    "Application":"Tractors",
    "Model":"TX25HLX85",
    "ProductName":"TX25H Tractor & Loader",
    "SKU":"6014687",
    "Price":"$19,499",
    "DescriptionShort":"Compact, diesel-powered tractor with loader.",
    "DescriptionLong":"The Summit TX25H compact tractor is a versatile machine designed for exceptional performance in a small, easy-to-maneuver package. With standard front-end loader and intuitive controls, it excels at property maintenance, landscaping, gardening, and light construction tasks.",
    "KeyFeatures":"24.7 HP diesel; Hydrostatic transmission; SSQA loader 1,200 lb; 4WD; Mid & Rear PTO; LED lights",
    "ImageURLs":"https://summittractors.com/summitpics/Dump---Copy.png",
    "VideoURL":"https://youtu.be/IT1jIBeAGvw",
    "BrochureURL":"https://summittractors.com/8.5x11-brochure-3.24.25.pdf",
    "ManualURL":"https://summittractors.com/manuals/Summit%20TX25%20Operator%20Manual.pdf",
    "SeasonalUsesURLs":"https://summittractors.com/pdf/seasonaluses/CompleteSeasonaUsesBook.pdf",
    "SortOrder":1,
    "Active":true
  },
  {
    "ProductID":"PI-TX25HLX85BHX76",
    "Category":"Tractors",
    "Application":"Tractors",
    "Model":"TX25HLX85BHX76",
    "ProductName":"TX25H Tractor & Loader w/ Backhoe",
    "SKU":"6014686",
    "Price":"$27,499",
    "DescriptionShort":"TX25H paired with BHX76 Backhoe for trenching and digging.",
    "DescriptionLong":"Pairing the Summit BHX76 Backhoe with the Summit TX25H delivers digging depth and versatility for trenching, planting, stump removal, and property projects.",
    "KeyFeatures":"TX25H + BHX76; Hydrostatic; 4WD; Cat-1 hitch; LED lighting",
    "ImageURLs":"https://summittractors.com/summitpics/SUMMIT-TX25-BHX76-2.png",
    "VideoURL":"https://youtu.be/IT1jIBeAGvw",
    "BrochureURL":"https://summittractors.com/8.5x11-brochure-3.24.25.pdf",
    "ManualURL":"https://summittractors.com/manuals/Summit%20TX25%20Operator%20Manual.pdf",
    "SeasonalUsesURLs":"https://summittractors.com/pdf/seasonaluses/CompleteSeasonaUsesBook.pdf",
    "SortOrder":2,
    "Active":true
  },
  {
    "ProductID":"PI-GX54",
    "Category":"Material Handling",
    "Application":"Material Handling",
    "Model":"GX54",
    "ProductName":"54\" SSQA Grapple",
    "SKU":"12345678",
    "Price":"$2,499",
    "DescriptionShort":"Clamp, carry, and clear brush and debris fast.",
    "DescriptionLong":"The 54\" SSQA Grapple streamlines brush, log, and debris handling with strong clamping force and quick-attach compatibility.",
    "KeyFeatures":"SSQA compatible; Powerful clamp; Rugged frame; Easy hydraulics",
    "ImageURLs":"https://images.unsplash.com/photo-1544829728-e5cb9eedc2e8?q=80&w=1200&auto=format&fit=crop",
    "VideoURL":"",
    "BrochureURL":"https://summittractors.com/8.5x11-brochure-3.24.25.pdf",
    "ManualURL":"",
    "SeasonalUsesURLs":"",
    "SortOrder":3,
    "Active":true
  },
  {
    "ProductID":"PI-FMX60",
    "Category":"Mowing & Brush",
    "Application":"Mowing",
    "Model":"FMX60",
    "ProductName":"60\" Finish Mower",
    "SKU":"12345682",
    "Price":"$1,899",
    "DescriptionShort":"Get lawn-quality results across large areas.",
    "DescriptionLong":"Achieve lawn-quality results with a 60\" rear-mount finish mower featuring rear discharge and anti-scalp wheels.",
    "KeyFeatures":"Rear discharge; Anti-scalp wheels; Adjustable height; PTO driven",
    "ImageURLs":"https://images.unsplash.com/photo-1604335399108-993bd76032ef?q=80&w=1200&auto=format&fit=crop",
    "VideoURL":"",
    "BrochureURL":"https://summittractors.com/8.5x11-brochure-3.24.25.pdf",
    "ManualURL":"",
    "SeasonalUsesURLs":"",
    "SortOrder":7,
    "Active":true
  },
  {
    "ProductID":"PI-BOX60",
    "Category":"Grading & Driveways",
    "Application":"Grading",
    "Model":"BOX60",
    "ProductName":"60\" Box Blade",
    "SKU":"12345683",
    "Price":"$1,299",
    "DescriptionShort":"Maintain driveways and paths with ease.",
    "DescriptionLong":"Level, backfill, and maintain driveways or paths with a durable 60\" box blade.",
    "KeyFeatures":"Reversible edges; Scarifiers; Cat-1 hitch; Heavy-duty panels",
    "ImageURLs":"https://images.unsplash.com/photo-1502585591871-3680d590e1f3?q=80&w=1200&auto=format&fit=crop",
    "VideoURL":"",
    "BrochureURL":"https://summittractors.com/8.5x11-brochure-3.24.25.pdf",
    "ManualURL":"",
    "SeasonalUsesURLs":"",
    "SortOrder":8,
    "Active":true
  },
  {
    "ProductID":"PI-SPX600",
    "Category":"Snow & Ice",
    "Application":"Snow",
    "Model":"SPX600",
    "ProductName":"60\" Snow Pusher",
    "SKU":"12345686",
    "Price":"$999",
    "DescriptionShort":"Push more snow every pass.",
    "DescriptionLong":"A 60\" SSQA snow pusher for more coverage per pass during winter maintenance.",
    "KeyFeatures":"SSQA mount; Replaceable edge; Strong side plates",
    "ImageURLs":"https://images.unsplash.com/photo-1548072591-66e7b04a2bb7?q=80&w=1200&auto=format&fit=crop",
    "VideoURL":"",
    "BrochureURL":"https://summittractors.com/8.5x11-brochure-3.24.25.pdf",
    "ManualURL":"",
    "SeasonalUsesURLs":"",
    "SortOrder":11,
    "Active":true
  }
];

/* ---------- Utilities ---------- */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const currencyToNumber = (s) => {
  if (!s) return 0;
  const n = Number(String(s).replace(/[^0-9.]/g, ""));
  return isNaN(n) ? 0 : n;
};
const splitDelimited = (s) => (s||"").split(/[;|]/).map(x=>x.trim()).filter(Boolean);
const imageArray = (s) => (s||"").split(/[|]/).map(x=>x.trim()).filter(Boolean);
const ytToEmbed = (url) => {
  if (!url) return "";
  try {
    const u = new URL(url);
    if (u.hostname.includes("youtu")) {
      const id = u.searchParams.get("v") || u.pathname.split("/").filter(Boolean).pop();
      return `https://www.youtube-nocookie.com/embed/${id}`;
    }
    return url;
  } catch { return url; }
};

/* Minimal CSV parser supporting quotes & commas inside quotes */
function parseCSV(text){
  const rows=[], len=text.length; let i=0, cell="", row=[], inQ=false;
  const pushCell=()=>{row.push(cell);cell=""}; const pushRow=()=>{rows.push(row);row=[]};
  while(i<len){ const c=text[i++];
    if(inQ){ if(c=='"'){ if(text[i]=='"'){cell+='"';i++;} else inQ=false; } else cell+=c; }
    else { if(c=='"') inQ=true; else if(c==',') pushCell(); else if(c=='\n'){ pushCell(); pushRow(); } else if(c=='\r'){} else cell+=c; }
  }
  pushCell(); if(row.length) pushRow();
  if(!rows.length) return [];
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=> r.length && r.some(v=> String(v).trim().length)).map(r=>{
    const o={}; r.forEach((v,idx)=> o[headers[idx]||`col${idx}`]=String(v).trim());
    o.Active = String(o.Active||"").toLowerCase()==="true" || o.Active==="1" || String(o.Active||"").toLowerCase()==="yes";
    return o;
  });
}

/* ---------- State ---------- */
let PRODUCTS = [...SAMPLE_PRODUCTS];
let SELECTED = new Set(JSON.parse(localStorage.getItem("summit:selected")||"[]"));
let REMOVED_FOR_PRINT = new Set(JSON.parse(localStorage.getItem("summit:removedForPrint")||"[]"));
let FILTERED = []; // last filtered set
let DETAILS = { open:false, product:null, imgs:[], imgIdx:0 };
let CAPTCHA = { a: 2+Math.floor(Math.random()*7), b: 2+Math.floor(Math.random()*7) };

/* ---------- Init ---------- */
window.addEventListener("DOMContentLoaded", () => {
  try{ localStorage.removeItem('summit:selected'); localStorage.removeItem('summit:removedForPrint'); SELECTED = new Set(); REMOVED_FOR_PRINT = new Set(); showToast('Selections cleared'); }catch{};
  // nav
  $$('nav button').forEach(btn=> btn.addEventListener('click',()=> gotoStep(Number(btn.dataset.step))));
  $('#btnAdmin').addEventListener('click', () => {
    $('#adminBar').classList.toggle('hidden');
  });
  // inputs
  $('#csvInput').addEventListener('change', onCSVChosen);
  $('#year').textContent = new Date().getFullYear();
  $('#captchaQ').textContent = `Solve: ${CAPTCHA.a} + ${CAPTCHA.b} =`;
  // populate Application filter
  refreshFilterOptions();
  renderList();
  updateHeaderCounters();
  const expBtn = $('#btnExportCSV');
  if (expBtn) expBtn.addEventListener('click', exportCSV);});

function gotoStep(step){
  $$('main').forEach(m => m.classList.add('hidden'));
  $('#step'+step).classList.remove('hidden');
  $$('nav button').forEach(b => b.setAttribute('aria-current', b.dataset.step==step ? 'page' : 'false'));
  if(step===3) renderSelected();
  if(step===4) { $('#sendPhasePitch').classList.remove('hidden'); $('#leadForm').classList.add('hidden'); $('#leadThanks').classList.add('hidden'); }
}

function closeApp(){
  try{
    localStorage.removeItem('summit:selected');
    localStorage.removeItem('summit:removedForPrint');
    SELECTED = new Set();
    REMOVED_FOR_PRINT = new Set();
    updateHeaderCounters();
  }catch{}
  showToast('Selections cleared'); alert('This would close an overlay or navigate away in production.');
}

/* ---------- Filtering / Rendering ---------- */
function refreshFilterOptions(){
  const apps = Array.from(new Set(PRODUCTS.map(p=>p.Application).filter(Boolean)));
  const sel = $('#filterApp');
  sel.innerHTML = '<option>All</option>' + apps.map(a=> `<option>${a}</option>`).join('');
}
function renderList(){
  const q = $('#q').value.trim().toLowerCase();
  const app = $('#filterApp').value;
  const sort = $('#sortBy').value;
  let list = PRODUCTS.filter(p => p.Active!==false);
  if(app !== 'All') list = list.filter(p => (p.Application||'')===app);
  if(q){
    list = list.filter(p => [p.ProductName,p.DescriptionShort,p.Category,p.Model,String(p.SKU)].some(v => (v||'').toLowerCase().includes(q)));
  }
  const cmp = {
    "Name": (a,b)=> (a.ProductName||"").localeCompare(b.ProductName||""),
    "PriceLowHigh": (a,b)=> currencyToNumber(a.Price) - currencyToNumber(b.Price),
    "PriceHighLow": (a,b)=> currencyToNumber(b.Price) - currencyToNumber(a.Price),
    "SortOrder": (a,b)=> (Number(a.SortOrder)||0) - (Number(b.SortOrder)||0),
  }[sort] || (()=>0);
  FILTERED = [...list].sort(cmp);
  $('#stats').textContent = `Showing ${FILTERED.length} of ${PRODUCTS.length}${app!=='All' ? ' in ' + app : ''}.`;
  const cards = FILTERED.map(renderCard).join('');
  $('#cards').innerHTML = cards;
}
function renderCard(p){
  const selected = SELECTED.has(p.ProductID);
  const img = imageArray(p.ImageURLs)[0] || "https://placehold.co/600x400?text=No+Image";
  return `<div class="card ${selected?'selected':''}">
    ${selected ? `<div class="badge">✔ Selected</div>`:''}
    <img src="${img}" alt="${escapeHtml(p.ProductName||'Product')}" />
    <div class="card-body">
      <div class="tag">${escapeHtml(p.Category||'')} • ${escapeHtml(p.Application||'')}</div>
      <div class="title" style="margin-top:4px">${escapeHtml(p.ProductName||'')}</div>
      <div class="muted">SKU ${escapeHtml(String(p.SKU||''))}</div>
      <div style="margin-top:6px;font-weight:700">${escapeHtml(p.Price||'')}</div>
      <p class="muted" style="margin:.35rem 0 0">${escapeHtml(p.DescriptionShort||'')}</p>
      <div class="row" style="margin-top:10px">
        <button class="btn sm" onclick='openDetails(${JSON.stringify(p.ProductID)})'>See Details</button>
        <button class="btn sm primary" onclick='toggleSelect(${JSON.stringify(p.ProductID)})'>${selected?'Deselect':'Select'}</button>
        <a class="btn sm" href="${CONFIG.retailerURL}" target="_blank" rel="noreferrer">Find a Retailer</a>
      </div>
    </div>
  </div>`;
}

/* ---------- Selection ---------- */
function toggleSelect(id){
  if(SELECTED.has(id)) SELECTED.delete(id); else SELECTED.add(id);
  localStorage.setItem('summit:selected', JSON.stringify(Array.from(SELECTED)));
  renderList(); updateHeaderCounters();
}
function selectAllFiltered(){ FILTERED.forEach(p => SELECTED.add(p.ProductID)); localStorage.setItem('summit:selected', JSON.stringify(Array.from(SELECTED))); renderList(); updateHeaderCounters(); }
function removeAllFiltered(){ FILTERED.forEach(p => SELECTED.delete(p.ProductID)); localStorage.setItem('summit:selected', JSON.stringify(Array.from(SELECTED))); renderList(); updateHeaderCounters(); }
function updateHeaderCounters(){
  $('#selCount').textContent = SELECTED.size;
  const total = Array.from(SELECTED).reduce((sum,id)=>{
    const p = PRODUCTS.find(pp=> pp.ProductID===id);
    return sum + (p? currencyToNumber(p.Price):0);
  },0);
  $('#selTotal').textContent = total.toLocaleString();
}

/* ---------- Details Modal ---------- */
function openDetails(id){
  const p = PRODUCTS.find(pp=> pp.ProductID===id);
  if(!p) return;
  DETAILS.product = p;
  DETAILS.imgs = imageArray(p.ImageURLs);
  DETAILS.imgIdx = 0;
  $('#mdTitle').textContent = p.ProductName || 'Product Details';
  $('#mdImg').src = DETAILS.imgs[0] || "https://placehold.co/800x600?text=No+Image";
  $('#mdLong').textContent = p.DescriptionLong || '';
  const feats = splitDelimited(p.KeyFeatures).slice(0,5).map(f => `<li>${escapeHtml(f)}</li>`).join('');
  $('#mdFeat').innerHTML = feats || '<li>No features listed</li>';
  $('#mdVideo').src = ytToEmbed(p.VideoURL||"");
  $('#mdBrochure').src = p.BrochureURL || "";
  $('#mdManual').src = p.ManualURL || "";
  $('#mdSeasonal').src = p.SeasonalUsesURLs || "";
  $('#modalBackdrop').classList.remove('hidden');
}
function closeModal(){ $('#modalBackdrop').classList.add('hidden'); }
function prevImg(){ if(!DETAILS.imgs.length) return; DETAILS.imgIdx=(DETAILS.imgIdx-1+DETAILS.imgs.length)%DETAILS.imgs.length; $('#mdImg').src = DETAILS.imgs[DETAILS.imgIdx]; }
function nextImg(){ if(!DETAILS.imgs.length) return; DETAILS.imgIdx=(DETAILS.imgIdx+1)%DETAILS.imgs.length; $('#mdImg').src = DETAILS.imgs[DETAILS.imgIdx]; }

/* ---------- Save / Print ---------- */
function renderSelected(){
  const list = PRODUCTS.filter(p => SELECTED.has(p.ProductID));
  const html = list.map(p => {
    const removed = REMOVED_FOR_PRINT.has(p.ProductID);
    const img = imageArray(p.ImageURLs)[0] || "https://placehold.co/600x400?text=No+Image";
    return `<div class="panel" style="opacity:${removed?'.6':'1'};filter:${removed?'grayscale(1)':'none'}">
      <div class="grid" style="grid-template-columns:160px 1fr;gap:12px">
        <img src="${img}" alt="${escapeHtml(p.ProductName)}" style="width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid var(--border)" />
        <div>
          <div class="title">${escapeHtml(p.ProductName)}</div>
          <div class="muted">SKU ${escapeHtml(String(p.SKU||''))}</div>
          <div style="font-weight:700;margin-top:4px">${escapeHtml(p.Price||'')}</div>
          <p class="muted" style="margin:.35rem 0 0">${escapeHtml(p.DescriptionShort||'')}</p>
          <div class="row no-print" style="margin-top:8px">
            <button class="btn sm" onclick='toggleRemoveForPrint(${JSON.stringify(p.ProductID)})'>${removed?'Restore':'Remove from print'}</button>
          </div>
        </div>
      </div>
      ${removed?'<div class="muted" style="margin-top:6px;font-size:.85rem">Removed (will not appear in print)</div>':''}
    </div>`;
  }).join('') || '<p class="muted">No products selected yet. Go to <strong>View & Select</strong> to add items.</p>';
  $('#selectedList').innerHTML = html;
}
function toggleRemoveForPrint(id){
  if(REMOVED_FOR_PRINT.has(id)) REMOVED_FOR_PRINT.delete(id); else REMOVED_FOR_PRINT.add(id);
  localStorage.setItem('summit:removedForPrint', JSON.stringify(Array.from(REMOVED_FOR_PRINT)));
  renderSelected();
}

/* ---------- Send Flow ---------- */
function openLeadForm(){
  $('#sendPhasePitch').classList.add('hidden');
  $('#leadForm').classList.remove('hidden');
  $('#leadThanks').classList.add('hidden');
  renderSendingList();
}
function renderSendingList(){
  const list = PRODUCTS.filter(p => SELECTED.has(p.ProductID)).map(p => ({
    id: p.ProductID, name: p.ProductName, sku: String(p.SKU||''), price: p.Price, img: (imageArray(p.ImageURLs)[0]||'')
  }));
  const html = list.map(x => `<div class="panel" style="padding:8px">
      <div class="row" style="align-items:center">
        <img src="${x.img}" alt="" style="width:72px;height:54px;object-fit:cover;border-radius:8px;border:1px solid var(--border)" />
        <div style="min-width:0">
          <div class="title" style="font-size:.95rem">${escapeHtml(x.name)}</div>
          <div class="muted" style="font-size:.85rem">SKU ${escapeHtml(x.sku)} • ${escapeHtml(x.price||'')}</div>
        </div>
      </div>
    </div>`).join('') || '<div class="muted">No products selected.</div>';
  $('#sendingList').innerHTML = html;
}
async function submitLead(e){
  e.preventDefault();
  $('#leadErr').textContent = '';
  const name = $('#name').value.trim();
  const email = $('#email').value.trim();
  const phone = $('#phone').value.trim();
  const notes = $('#notes').value.trim();
  const hp = $('#hpCompany').value.trim(); // honeypot
  const ans = Number($('#captchaA').value);
  const expected = CAPTCHA.a + CAPTCHA.b;
  if(!name || !email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
    $('#leadErr').textContent = 'Please provide your name and a valid email address.'; return;
  }
  if(hp){ $('#leadErr').textContent = 'Spam detected.'; return; }
  if(ans !== expected){ $('#leadErr').textContent = 'Captcha answer is incorrect.'; return; }

  const selected = PRODUCTS.filter(p => SELECTED.has(p.ProductID));
  const payload = {
    contact: { name, email, phone, notes },
    selectedProductIDs: selected.map(p=> p.ProductID),
    selectedSummary: selected.map(p=> ({ id: p.ProductID, name: p.ProductName, sku: String(p.SKU||''), price: p.Price })).slice(0,100),
    timestamp: new Date().toISOString()
  };
  const mode = $('#sendMode').value;

  try{
    $('#btnSubmitLead').disabled = true;
    if(mode==='email'){
      // POST to your server-side email handler
      await fetch(CONFIG.email.endpoint, {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...CONFIG.email.headers },
        body: JSON.stringify(payload)
      }).then(r=>{ if(!r.ok) throw new Error('Email submit failed'); });
    } else {
      // Build a Web-to-Lead POST by creating and submitting a form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = CONFIG.salesforce.endpoint;
      form.target = '_blank'; // submit in new tab to avoid CORS
      form.style.display='none';
      // required org id
      addHidden(form, 'oid', CONFIG.salesforce.orgId);
      // map fields
      const m = CONFIG.salesforce.fieldMap;
      addHidden(form, m.last_name || 'last_name', name);
      addHidden(form, m.email || 'email', email);
      if(m.phone) addHidden(form, m.phone, phone);
      // Put notes + product summary into description
      const summary = payload.selectedSummary.map(x => `• ${x.name} (SKU ${x.sku}) ${x.price||''}`).join('\\n');
      const description = (notes? (notes + '\\n\\n') : '') + 'Selected products:\\n' + summary;
      addHidden(form, m.description || 'description', description);
      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);
    }
    // Show thanks
    $('#leadForm').classList.add('hidden');
    $('#leadThanks').classList.remove('hidden');
  }catch(err){
    console.error(err);
    $('#leadErr').textContent = 'Submission failed. Please try again or contact us.';
  }finally{
    $('#btnSubmitLead').disabled = false;
  }
}
function addHidden(form, name, value){
  const input = document.createElement('input');
  input.type='hidden'; input.name=name; input.value=value||'';
  form.appendChild(input);
}


/* ---------- CSV Export (Admin) ---------- */
function exportCSV(){
  // Build a consistent, round-trippable CSV using the same columns as import
  const headers = [
    "ProductID","Category","Application","Model","ProductName","SKU","Price",
    "DescriptionShort","DescriptionLong","KeyFeatures","SeasonalUsesURLs",
    "ImageURLs","VideoURL","BrochureURL","ManualURL","SortOrder","Active"
  ];
  const rows = [headers].concat(PRODUCTS.map(p => ([
    p.ProductID||"", p.Category||"", p.Application||"", p.Model||"", p.ProductName||"",
    String(p.SKU||""), p.Price||"", p.DescriptionShort||"", p.DescriptionLong||"",
    p.KeyFeatures||"", p.SeasonalUsesURLs||"", p.ImageURLs||"", p.VideoURL||"",
    p.BrochureURL||"", p.ManualURL||"", (Number(p.SortOrder)||0),
    (p.Active===false? false : true)
  ])));
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = `products-export-${ts}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function toCSV(rows){
  const esc = (v)=> {
    const s = String(v ?? '');
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  };
  return rows.map(r => r.map(esc).join(',')).join('\n');
}


/* ---------- CSV Persist Helpers ---------- */
function setProductsFromRows(rows, versionLabel, loadedLabel){
  const mapped = rows.map(r => ({
    ProductID: r.ProductID,
    Category: r.Category,
    Application: r.Application,
    Model: r.Model,
    ProductName: r.ProductName,
    SKU: String(r.SKU || ""),
    Price: r.Price,
    DescriptionShort: r.DescriptionShort,
    DescriptionLong: r.DescriptionLong,
    KeyFeatures: r.KeyFeatures,
    SeasonalUsesURLs: r.SeasonalUsesURLs,
    ImageURLs: r.ImageURLs,
    VideoURL: r.VideoURL,
    BrochureURL: r.BrochureURL || r.SpecsURL || r.BrochureURL_SpecsURL,
    ManualURL: r.ManualURL,
    SortOrder: Number(r.SortOrder || 0),
    Active: String(r.Active).toLowerCase()==="true" || r.Active===true
  })).filter(p => p.Active);
  PRODUCTS = mapped;
  // retain selection ids that still exist
  SELECTED = new Set(Array.from(SELECTED).filter(id => PRODUCTS.some(p => p.ProductID===id)));
  refreshFilterOptions();
  renderList();
  updateHeaderCounters();
  if($('#csvVersion')) $('#csvVersion').textContent = versionLabel || 'Last Import';
  if($('#csvLoaded')) $('#csvLoaded').textContent = loadedLabel || new Date().toLocaleString();
}

function tryRestoreLastCSV(){
  try{
    const saved = localStorage.getItem('summit:lastCSV');
    if(!saved) return false;
    const meta = JSON.parse(localStorage.getItem('summit:lastCSV_meta')||'{}');
    const rows = parseCSV(saved).filter(r => r.Active);
    if(!rows.length) return false;
    setProductsFromRows(rows, meta.name ? meta.name : 'Last Import', (meta.when ? (new Date(meta.when).toLocaleString()) : new Date().toLocaleString()) + ' (restored)');
    return true;
  }catch(e){ console.warn('Restore failed', e); return false;}
}

/* ---------- CSV Import (Admin) ---------- */

async function onCSVChosen(e){
  const file = e.target.files?.[0];
  if(!file) return;
  const text = await file.text();
  // persist raw CSV + meta
  try{
    localStorage.setItem('summit:lastCSV', text);
    localStorage.setItem('summit:lastCSV_meta', JSON.stringify({ name: file.name, when: Date.now() }));
  }catch{ /* storage may fail */ }

  const rows = parseCSV(text).filter(r => r.Active);
  setProductsFromRows(rows, file.name, new Date().toLocaleString());
}



/* ---------- Toast Helper ---------- */
function showToast(msg){
  const t = $('#toast');
  if(!t) return;
  t.textContent = msg;
  t.style.opacity = '1';
  setTimeout(()=>{ t.style.opacity = '0'; }, 2500);
}

/* ---------- Helpers ---------- */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
</script>

<div id="toast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#254a4f;color:#fff;padding:10px 16px;border-radius:8px;font-size:.9rem;opacity:0;pointer-events:none;transition:opacity .4s"></div>
</body>
</html>
